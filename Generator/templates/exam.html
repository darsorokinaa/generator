{% extends 'base.html' %}
{% load static %}

{% block title %}–í–∞—Ä–∏–∞–Ω—Ç ‚Ññ {{ variant.id }}{% endblock %}

{% block content %}

<style>


</style>


<button id="open-board">
    –î–æ—Å–∫–∞
</button>

<div class="main-wrapper" id="main-wrapper">
    <div class="content-area">
        <div class="container">
            <div class="page">

                <div class="header">
                    <div class="header-left">
                        <h1>–í–∞—Ä–∏–∞–Ω—Ç ‚Ññ {{ variant.id }}</h1>
                    </div>
                    <div class="header-right">
                        <div class="score-counter" id="scoreCounter" style="display:none;">
                            <span>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
                            <span>
                                <span id="correctCount">0</span> /
                                <span id="totalCount">{{ tasks|length }}</span>
                            </span>
                        </div>
                        <button id="checkButton" onclick="checkAllAnswers()">
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
                        </button>
                    </div>
                </div>

                {% for task in tasks %}
                <section class="task">
                    <aside class="task-left">
                        <div class="task-number">
                            {{ task.task.task_number }}
                        </div>
                        <div class="task-id">
                            {{ task.id }}
                        </div>
                    </aside>

                    <article class="task-content">
                        <div class="task-text">
                            {{ task.task_template|safe }}
                        </div>

                        <div class="answer-section">
                            <input 
                                type="text"
                                class="answer-input"
                                data-correct-answer="{{ task.answer }}"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"
                            />
                            <span class="answer-status"></span>

                            <div class="correct-answer-display" style="display:none;">
                                –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {{ task.answer }}
                            </div>
                        </div>
                    </article>
                </section>
                {% endfor %}

            </div>
        </div>
    </div>
</div>

<div id="board-sidebar" class="board-sidebar">
    <div class="resize-handle" id="resize-handle"></div>
    <div class="board-header">
        <span class="board-title">üìù –î–æ—Å–∫–∞ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è</span>
        <div class="board-controls">
            <span class="width-display" id="width-display">50%</span>
            <button id="close-board">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    <iframe 
        id="excalidraw-iframe"
        src="https://excalidraw.com"
        allow="clipboard-read; clipboard-write"
        loading="lazy">
    </iframe>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    /* =========================
       –î–û–°–ö–ê –ò –ò–ó–ú–ï–ù–ï–ù–ò–ï –†–ê–ó–ú–ï–†–ê
    ========================== */

    const mainWrapper = document.getElementById("main-wrapper");
    const sidebar = document.getElementById("board-sidebar");
    const openBtn = document.getElementById("open-board");
    const closeBtn = document.getElementById("close-board");
    const resizeHandle = document.getElementById("resize-handle");
    const widthDisplay = document.getElementById("width-display");

    let boardWidth = 50; // –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
    let isResizing = false;

    function setBoardWidth(widthPercent) {
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –æ—Ç 20% –¥–æ 80%
        widthPercent = Math.max(20, Math.min(80, widthPercent));
        boardWidth = widthPercent;
        
        const widthValue = `${widthPercent}vw`;
        document.documentElement.style.setProperty('--board-width', widthValue);
        widthDisplay.textContent = `${Math.round(widthPercent)}%`;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        localStorage.setItem('boardWidth', widthPercent);
    }

    function openBoard() {
        sidebar.classList.add("active");
        mainWrapper.classList.add("board-open");
        openBtn.classList.add("hidden");
    }

    function closeBoard() {
        sidebar.classList.remove("active");
        mainWrapper.classList.remove("board-open");
        openBtn.classList.remove("hidden");
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É
    const savedWidth = localStorage.getItem('boardWidth');
    if (savedWidth) {
        setBoardWidth(parseFloat(savedWidth));
    } else {
        setBoardWidth(50);
    }

    openBtn.addEventListener("click", openBoard);
    closeBtn.addEventListener("click", closeBoard);

    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape" && sidebar.classList.contains("active")) {
            closeBoard();
        }
    });

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –¥–æ—Å–∫–∏
    resizeHandle.addEventListener("mousedown", function(e) {
        isResizing = true;
        resizeHandle.classList.add("dragging");
        sidebar.classList.add("resizing");
        mainWrapper.classList.add("resizing");
        document.body.style.cursor = "ew-resize";
        document.body.style.userSelect = "none";
    });

    document.addEventListener("mousemove", function(e) {
        if (!isResizing) return;

        const windowWidth = window.innerWidth;
        const mouseX = e.clientX;
        const widthInPixels = windowWidth - mouseX;
        const widthPercent = (widthInPixels / windowWidth) * 100;

        setBoardWidth(widthPercent);
    });

    document.addEventListener("mouseup", function() {
        if (isResizing) {
            isResizing = false;
            resizeHandle.classList.remove("dragging");
            sidebar.classList.remove("resizing");
            mainWrapper.classList.remove("resizing");
            document.body.style.cursor = "";
            document.body.style.userSelect = "";
        }
    });

    /* =========================
       –ü–†–û–í–ï–†–ö–ê –û–¢–í–ï–¢–û–í
    ========================== */

    let isChecked = false;

    function normalizeAnswer(answer) {
        return answer.toString().trim().toLowerCase().replace(/\s+/g, '');
    }

    window.checkAllAnswers = function () {

        if (isChecked) {
            resetAnswers();
            return;
        }

        const inputs = document.querySelectorAll('.answer-input');
        let correctCount = 0;

        inputs.forEach(input => {
    const userAnswer = normalizeAnswer(input.value);
    const correctAnswer = normalizeAnswer(input.dataset.correctAnswer);

    const statusIcon = input.nextElementSibling;
    const correctDisplay = input.parentElement.querySelector('.correct-answer-display');

    input.disabled = true;

    if (userAnswer !== "" && userAnswer === correctAnswer) {
        if (statusIcon) statusIcon.textContent = "‚úì";
        correctCount++;
    } else {
        if (statusIcon) statusIcon.textContent = "‚úó";
        if (correctDisplay) correctDisplay.style.display = "block";
    }
});


        const correctCountEl = document.getElementById('correctCount');
        const scoreCounter = document.getElementById('scoreCounter');
        const checkButton = document.getElementById('checkButton');

        if (correctCountEl) correctCountEl.textContent = correctCount;
        if (scoreCounter) scoreCounter.style.display = 'flex';
        if (checkButton) {checkButton.textContent = "–°–±—Ä–æ—Å–∏—Ç—å";
checkButton.classList.add("reset-mode");}


        isChecked = true;
    };

    function resetAnswers() {
        const inputs = document.querySelectorAll('.answer-input');

        inputs.forEach(input => {
            input.disabled = false;
            input.value = "";
            
            const statusIcon = input.nextElementSibling;
            const correctDisplay = input.parentElement.querySelector('.correct-answer-display');
            
            if (statusIcon) statusIcon.textContent = "";
            if (correctDisplay) correctDisplay.style.display = "none";
        });

        const scoreCounter = document.getElementById('scoreCounter');
        const checkButton = document.getElementById('checkButton');

        if (scoreCounter) scoreCounter.style.display = 'none';
        if (checkButton) {
            checkButton.textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã";
checkButton.classList.remove("reset-mode");

        }

        isChecked = false;
    }

});
</script>

{% endblock %}