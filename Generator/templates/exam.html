{% extends 'base.html' %}
{% load static %}

{% block title %}–í–∞—Ä–∏–∞–Ω—Ç ‚Ññ {{ variant.id }}{% endblock %}

{% block content %}

<style>
/* –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–æ—Å–∫–∏ */
#open-board-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    padding: 15px 25px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 8px;
}

#open-board-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

#open-board-btn.hidden {
    display: none;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ—Å–∫–∏ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
#board-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: none;
    flex-direction: column;
    pointer-events: none;
}

#board-container.active {
    display: flex;
}

/* Toolbar –¥–æ—Å–∫–∏ */
#board-toolbar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
    pointer-events: auto;
}

#board-toolbar button {
    padding: 8px 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
}

#board-toolbar button:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
}

#board-toolbar button.active {
    background: white;
    color: #667eea;
    border-color: white;
}

.color-picker {
    display: flex;
    gap: 8px;
}

.color-btn {
    width: 32px;
    height: 32px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
}

.color-btn:hover {
    transform: scale(1.15);
    border-color: rgba(255, 255, 255, 0.6);
}

.color-btn.active {
    border-color: white;
    border-width: 3px;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.divider {
    width: 1px;
    height: 24px;
    background: rgba(255, 255, 255, 0.3);
    margin: 0 5px;
}

#close-board-btn {
    margin-left: auto;
    background: rgba(244, 67, 54, 0.2) !important;
    border-color: rgba(255, 255, 255, 0.4) !important;
}

#close-board-btn:hover {
    background: rgba(244, 67, 54, 0.4) !important;
}

/* Canvas - –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–ª–æ–π –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
#board {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    cursor: crosshair;
    pointer-events: auto;
    z-index: 999;
}

/* –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –¥–æ—Å–∫–µ —Å–º–µ—â–∞–µ–º canvas –≤–Ω–∏–∑ –ø–æ–¥ toolbar */
#board-container.active #board {
    top: 65px; /* –≤—ã—Å–æ—Ç–∞ toolbar */
    height: calc(100vh - 65px);
}
</style>

<button id="open-board-btn" onclick="toggleBoard()">
    ‚úèÔ∏è –û—Ç–∫—Ä—ã—Ç—å –¥–æ—Å–∫—É
</button>

<div class="main-wrapper" id="main-wrapper">
    <div class="content-area">
        <div class="container">
            <div class="page">

                <div class="header">
                    <div class="header-left">
                        <h1>–í–∞—Ä–∏–∞–Ω—Ç ‚Ññ {{ variant.id }}</h1>
                    </div>
                    <div class="header-right">
                        <div class="score-counter" id="scoreCounter" style="display:none;">
                            <span>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</span>
                            <span>
                                <span id="correctCount">0</span> /
                                <span id="totalCount">{{ tasks|length }}</span>
                            </span>
                        </div>
                        <button id="checkButton" onclick="checkAllAnswers()">
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
                        </button>
                    </div>
                </div>

                {% for task in tasks %}
                <section class="task">
                    <aside class="task-left">
                        <div class="task-number">
                            {{ task.task.task_number }}
                        </div>
                        <div class="task-id">
                            {{ task.id }}
                        </div>
                    </aside>

                    <article class="task-content">
                        <div class="task-text">
                            {{ task.task_template|safe }}
                        </div>

                        <div class="answer-section">
                            <input 
                                type="text"
                                class="answer-input"
                                data-correct-answer="{{ task.answer }}"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç"
                            />
                            <span class="answer-status"></span>

                            <div class="correct-answer-display" style="display:none;">
                                –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: {{ task.answer }}
                            </div>
                        </div>
                    </article>
                </section>
                {% endfor %}

            </div>
        </div>
    </div>
</div>

<!-- –î–æ—Å–∫–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω -->
<div id="board-container">
    <div id="board-toolbar">
        <button id="penBtn" onclick="setTool('pen')" class="active">‚úèÔ∏è –†—É—á–∫–∞</button>
        <button id="eraserBtn" onclick="setTool('eraser')">üßπ –õ–∞—Å—Ç–∏–∫</button>
        
        <div class="divider"></div>
        
        <div class="color-picker">
            <div class="color-btn active" style="background: #000000;" onclick="setColor('#000000')"></div>
            <div class="color-btn" style="background: #2196F3;" onclick="setColor('#2196F3')"></div>
            <div class="color-btn" style="background: #F44336;" onclick="setColor('#F44336')"></div>
        </div>
        
        <div class="divider"></div>
        
        <button id="clear-board-btn" onclick="clearBoard()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        
        <button id="close-board-btn" onclick="toggleBoard()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <canvas id="board"></canvas>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    /* =========================
       –î–û–°–ö–ê –î–õ–Ø –†–ò–°–û–í–ê–ù–ò–Ø
    ========================== */
    
    const canvas = document.getElementById("board");
    const ctx = canvas.getContext("2d");
    const boardContainer = document.getElementById("board-container");
    const openBoardBtn = document.getElementById("open-board-btn");
    const toolbar = document.getElementById("board-toolbar");

    let drawing = false;
    let tool = "pen";
    let currentLine = null;
    let objects = [];
    let currentColor = "#000000";
    let erasing = false;
    let erasedIndices = new Set();
    let scrollOffset = { x: 0, y: 0 };

    const penBtn = document.getElementById("penBtn");
    const eraserBtn = document.getElementById("eraserBtn");

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas
    function resizeCanvas() {
        const toolbarHeight = toolbar.offsetHeight;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight - toolbarHeight;
        redraw();
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å —É—á–µ—Ç–æ–º —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const scrollY = window.scrollY || window.pageYOffset;
        const scrollX = window.scrollX || window.pageXOffset;
        
        return {
            x: e.clientX - rect.left + scrollX,
            y: e.clientY - rect.top + scrollY
        };
    }

    window.toggleBoard = function() {
        boardContainer.classList.toggle('active');
        openBoardBtn.classList.toggle('hidden');
        
        if (boardContainer.classList.contains('active')) {
            resizeCanvas();
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞
            scrollOffset.x = window.scrollX;
            scrollOffset.y = window.scrollY;
        }
    };

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('scroll', function() {
        if (boardContainer.classList.contains('active')) {
            scrollOffset.x = window.scrollX;
            scrollOffset.y = window.scrollY;
            redraw();
        }
    });

    window.clearBoard = function() {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –¥–æ—Å–∫—É?')) {
            objects = [];
            redraw();
            socket.send(JSON.stringify({
                action: "clear_all"
            }));
        }
    };

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ –æ–∫–Ω–∞
    window.addEventListener('resize', function() {
        if (boardContainer.classList.contains('active')) {
            resizeCanvas();
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && boardContainer.classList.contains('active')) {
            toggleBoard();
        }
    });

    window.setTool = function(t) {
        tool = t;
        
        penBtn.classList.remove('active');
        eraserBtn.classList.remove('active');
        
        if(t === 'pen') {
            penBtn.classList.add('active');
            canvas.style.cursor = 'crosshair';
        } else if(t === 'eraser') {
            eraserBtn.classList.add('active');
            canvas.style.cursor = 'pointer';
        }
    };

    window.setColor = function(color) {
        currentColor = color;
        
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        event.target.classList.add('active');
        
        if(tool !== 'pen'){
            setTool('pen');
        }
    };

    const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const socket = new WebSocket(
        protocol + window.location.host + "/ws/board/test/"
    );

    canvas.addEventListener("mousedown", (e) => {
        e.preventDefault();
        const pos = getMousePos(e);
        
        drawing = true;

        if(tool === "pen"){
            currentLine = {
                type: "line",
                color: currentColor,
                width: 3,
                points: [pos]
            };
            redraw();
        }

        if(tool === "eraser"){
            erasing = true;
            erasedIndices.clear();
            eraseAt(pos.x, pos.y);
        }
    });

    canvas.addEventListener("mouseup", (e) => {
        e.preventDefault();
        if(currentLine){
            objects.push(currentLine);
            socket.send(JSON.stringify({
                action: "add_object",
                object: currentLine
            }));
            currentLine = null;
        }
        drawing = false;
        erasing = false;
        erasedIndices.clear();
    });

    canvas.addEventListener("mousemove", (e) => {
        e.preventDefault();
        if(!drawing) return;
        
        const pos = getMousePos(e);

        if(tool === "pen" && currentLine){
            currentLine.points.push(pos);
            redraw();
        }

        if(tool === "eraser" && erasing){
            eraseAt(pos.x, pos.y);
        }
    });

    canvas.addEventListener("mouseleave", () => {
        if(drawing && currentLine){
            objects.push(currentLine);
            socket.send(JSON.stringify({
                action: "add_object",
                object: currentLine
            }));
            currentLine = null;
        }
        drawing = false;
        erasing = false;
        erasedIndices.clear();
    });

    socket.onmessage = function(e){
        const data = JSON.parse(e.data);

        if(data.action === "add_object"){
            objects.push(data.object);
            redraw();
        }

        if(data.action === "remove_object"){
            objects = objects.filter((_, index) => index !== data.index);
            redraw();
        }

        if(data.action === "clear_all"){
            objects = [];
            redraw();
        }
    };

    function drawSmoothLine(points, color, width) {
        if (points.length < 1) return;
        
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        
        if (points.length === 1) {
            ctx.beginPath();
            ctx.arc(points[0].x - scrollOffset.x, points[0].y - scrollOffset.y, width / 2, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            return;
        }
        
        ctx.beginPath();
        ctx.moveTo(points[0].x - scrollOffset.x, points[0].y - scrollOffset.y);
        
        for (let i = 1; i < points.length - 1; i++) {
            const xc = (points[i].x + points[i + 1].x) / 2 - scrollOffset.x;
            const yc = (points[i].y + points[i + 1].y) / 2 - scrollOffset.y;
            ctx.quadraticCurveTo(
                points[i].x - scrollOffset.x, 
                points[i].y - scrollOffset.y, 
                xc, 
                yc
            );
        }
        
        ctx.lineTo(
            points[points.length - 1].x - scrollOffset.x, 
            points[points.length - 1].y - scrollOffset.y
        );
        ctx.stroke();
    }

    function redraw(){
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        objects.forEach((obj) => {
            if(obj.type === "line"){
                drawSmoothLine(obj.points, obj.color, obj.width);
            }
        });

        if(currentLine){
            drawSmoothLine(currentLine.points, currentLine.color, currentLine.width);
        }
    }

    function eraseAt(x, y){
        const radius = 8;

        for(let i = objects.length - 1; i >= 0; i--){
            if(erasedIndices.has(i)) continue;
            
            const obj = objects[i];

            if(obj.type === "line"){
                let foundMatch = false;
                for(let point of obj.points){
                    const dx = point.x - x;
                    const dy = point.y - y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if(distance < radius){
                        foundMatch = true;
                        break;
                    }
                }
                
                if(foundMatch){
                    erasedIndices.add(i);
                    objects.splice(i, 1);
                    socket.send(JSON.stringify({
                        action: "remove_object",
                        index: i
                    }));
                    redraw();
                    return;
                }
            }
        }
    }

    /* =========================
       –ü–†–û–í–ï–†–ö–ê –û–¢–í–ï–¢–û–í
    ========================== */

    let isChecked = false;

    function normalizeAnswer(answer) {
        return String(answer).trim().toLowerCase().replace(/\s+/g, '');
    }

    window.checkAllAnswers = function () {

        if (isChecked) {
            resetAnswers();
            return;
        }

        const inputs = document.querySelectorAll('.answer-input');
        let correctCount = 0;

        inputs.forEach(input => {

            const userAnswer = normalizeAnswer(input.value);
            const correctAnswer = normalizeAnswer(input.dataset.correctAnswer);

            const statusIcon = input.nextElementSibling;
            const correctDisplay = input.parentElement.querySelector('.correct-answer-display');

            input.disabled = true;

            if (userAnswer && userAnswer === correctAnswer) {
                if (statusIcon) statusIcon.textContent = "‚úì";
                correctCount++;
            } else {
                if (statusIcon) statusIcon.textContent = "‚úó";
                if (correctDisplay) correctDisplay.style.display = "block";
            }
        });

        const correctCountEl = document.getElementById('correctCount');
        const scoreCounter = document.getElementById('scoreCounter');
        const checkButton = document.getElementById('checkButton');

        if (correctCountEl) correctCountEl.textContent = correctCount;
        if (scoreCounter) scoreCounter.style.display = 'flex';

        if (checkButton) {
            checkButton.textContent = "–°–±—Ä–æ—Å–∏—Ç—å";
            checkButton.classList.add("reset-mode");
        }

        isChecked = true;
    };

    function resetAnswers() {

        const inputs = document.querySelectorAll('.answer-input');

        inputs.forEach(input => {
            input.disabled = false;
            input.value = "";

            const statusIcon = input.nextElementSibling;
            const correctDisplay = input.parentElement.querySelector('.correct-answer-display');

            if (statusIcon) statusIcon.textContent = "";
            if (correctDisplay) correctDisplay.style.display = "none";
        });

        const scoreCounter = document.getElementById('scoreCounter');
        const checkButton = document.getElementById('checkButton');

        if (scoreCounter) scoreCounter.style.display = 'none';

        if (checkButton) {
            checkButton.textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã";
            checkButton.classList.remove("reset-mode");
        }

        isChecked = false;
    }

});
</script>

{% endblock %}